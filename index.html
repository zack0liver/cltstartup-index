<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="keywords" content="Charlotte startups, 704, CLT startups, Charlotte startup directory, Charlotte tech, Queen City startups">
    <title>CLT Startups | Directory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f5f2eb;
            --dark: #0a0f1e;
            --accent: #00e5a0;
            --surface: #ffffff;
            --border: #e8e4da;
            --text: #0a0f1e;
            --muted: #6b7280;
        }

        html { scroll-behavior: smooth; }
        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            -webkit-tap-highlight-color: transparent;
        }

        /* Cards */
        .startup-card {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--surface);
            border: 1.5px solid var(--border);
            border-radius: 16px;
            position: relative;
            overflow: hidden;
        }
        .startup-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--card-accent, #6366f1);
        }
        .startup-card:hover {
            transform: translateY(-3px);
            border-color: transparent;
            box-shadow: 0 20px 40px -12px rgba(10, 15, 30, 0.12), 0 0 0 1.5px var(--card-accent, #6366f1);
        }

        /* Category pills */
        .category-pill {
            white-space: nowrap;
            transition: all 0.2s;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.05em;
            box-shadow: 0 1px 3px rgba(10, 15, 30, 0.04);
        }
        .category-pill.active {
            background: var(--dark) !important;
            color: white !important;
            border-color: var(--dark) !important;
            box-shadow: 0 2px 8px rgba(10, 15, 30, 0.15);
        }
        .category-pill:not(.active):hover {
            background: var(--dark) !important;
            color: white !important;
            border-color: var(--dark) !important;
        }

        /* Utilities */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Modal */
        .modal-overlay {
            background: rgba(10, 15, 30, 0.65);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        main { min-height: 80vh; }

        /* Sidebar */
        .map-sidebar {
            position: sticky;
            top: 110px;
            height: fit-content;
            max-height: calc(100vh - 140px);
        }
        .map-sidebar > div {
            max-height: calc(100vh - 180px);
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
        }
        .map-sidebar > div::-webkit-scrollbar { width: 4px; }
        .map-sidebar > div::-webkit-scrollbar-track { background: transparent; }
        .map-sidebar > div::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        .map-sidebar > div::-webkit-scrollbar-thumb:hover { background: var(--muted); }

        .location-cluster {
            transition: all 0.2s ease;
            cursor: pointer;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            background: white;
        }
        .location-cluster:hover,
        .location-cluster.active {
            border-color: var(--dark);
            background: var(--dark);
        }
        .location-cluster:hover .cluster-name,
        .location-cluster.active .cluster-name { color: white !important; }
        .location-cluster:hover .cluster-count,
        .location-cluster.active .cluster-count { background: rgba(255,255,255,0.15) !important; color: white !important; }
        .location-cluster:hover .cluster-sub,
        .location-cluster.active .cluster-sub { color: rgba(255,255,255,0.55) !important; }

        .location-reset {
            transition: all 0.2s ease;
            cursor: pointer;
            border: 1.5px dashed var(--border);
            border-radius: 10px;
            background: transparent;
        }
        .location-reset:hover {
            border-color: var(--accent);
            background: rgba(0, 229, 160, 0.06);
        }
        .location-reset.active {
            border-color: var(--accent);
            border-style: solid;
            background: rgba(0, 229, 160, 0.08);
        }

        .location-pin { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .pin-hq { background: var(--accent); }
        .pin-hub { background: white; border: 2px solid var(--accent); }

        @media (max-width: 1280px) { .map-sidebar { display: none; } }
        @media (min-width: 1280px) { #locationChipsMobile { display: none; } }

        /* Hero decorative grid */
        .hero-grid {
            position: absolute;
            inset: 0;
            background-image:
                linear-gradient(rgba(255,255,255,0.04) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.04) 1px, transparent 1px);
            background-size: 48px 48px;
            pointer-events: none;
        }

        /* Gradient text */
        .gradient-text {
            background: linear-gradient(120deg, var(--accent) 0%, #60efff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Sticky search bar */
        #explore {
            background: rgba(245, 242, 235, 0.92);
            border-bottom: 1px solid var(--border);
            box-shadow: 0 4px 24px -4px rgba(10, 15, 30, 0.06);
        }

        /* Pulse dot */
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.85); }
        }
        .pulse-dot { animation: pulse-dot 2s ease-in-out infinite; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Nav -->
    <nav style="background: var(--dark);" class="px-6 py-4 relative z-10">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="text-xl font-black tracking-tight">
                <span class="text-white">CLT</span><span style="color: var(--accent);">Startups</span>
            </div>
            <div class="flex items-center gap-4">
                <a href="pulse.html" class="flex items-center gap-1.5 text-sm font-bold transition-all hover:opacity-70" style="color: rgba(255,255,255,0.65);">
                    <div class="pulse-dot" style="width: 6px; height: 6px; border-radius: 50%; background: var(--accent); flex-shrink: 0;"></div>
                    Pulse
                </a>
                <button onclick="openAddModal()" style="background: var(--accent); color: var(--dark);" class="px-5 py-2 rounded-full text-sm font-black hover:opacity-90 transition-all active:scale-95">
                    + Submit
                </button>
            </div>
        </div>
    </nav>

    <!-- Hero -->
    <section style="background: var(--dark);" class="relative overflow-hidden px-6 py-20 md:py-28">
        <div class="hero-grid"></div>
        <!-- Decorative 704 -->
        <div class="absolute right-[-2%] top-1/2 -translate-y-1/2 font-black leading-none select-none pointer-events-none"
             style="font-size: clamp(140px, 22vw, 340px); color: rgba(255,255,255,0.025); letter-spacing: -0.05em;">704</div>

        <div class="max-w-7xl mx-auto relative z-10">
            <!-- Live badge -->
            <div class="inline-flex items-center gap-2 mb-8"
                 style="background: rgba(0,229,160,0.1); border: 1px solid rgba(0,229,160,0.2); border-radius: 100px; padding: 6px 14px;">
                <div class="pulse-dot" style="width: 7px; height: 7px; border-radius: 50%; background: var(--accent); flex-shrink: 0;"></div>
                <span style="color: var(--accent);" class="text-xs font-bold uppercase tracking-widest">Live Index</span>
            </div>

            <h1 class="font-black text-white tracking-tighter leading-none mb-6"
                style="font-size: clamp(2.8rem, 7vw, 5.5rem);">
                The Queen City's<br>
                <span class="gradient-text">startup scene,</span><br>
                indexed.
            </h1>

            <p class="text-lg md:text-xl font-medium max-w-lg mb-10" style="color: rgba(255,255,255,0.45);">
                A community-built directory of startups building in Charlotte ‚Äî and the surrounding region.
            </p>

            <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center mb-12">
                <a href="#explore" style="background: var(--accent); color: var(--dark);"
                   class="px-8 py-3.5 rounded-full font-black text-sm hover:opacity-90 transition-all active:scale-95 inline-block">
                    Explore the Index ‚Üí
                </a>
                <button onclick="openAddModal()"
                        class="px-8 py-3.5 rounded-full font-bold text-sm transition-all active:scale-95"
                        style="border: 1.5px solid rgba(255,255,255,0.18); color: rgba(255,255,255,0.65); background: transparent;"
                        onmouseover="this.style.background='rgba(255,255,255,0.08)'"
                        onmouseout="this.style.background='transparent'">
                    Add a startup
                </button>
            </div>

            <!-- Live stats -->
            <div class="flex flex-wrap gap-3">
                <div style="border: 1px solid rgba(255,255,255,0.1); border-radius: 100px; padding: 6px 16px; font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.55);">
                    <span id="heroCount" class="text-white font-black">‚Äî</span> startups
                </div>
                <div style="border: 1px solid rgba(255,255,255,0.1); border-radius: 100px; padding: 6px 16px; font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.55);">
                    <span id="heroCats" class="text-white font-black">‚Äî</span> industries
                </div>
                <div style="border: 1px solid rgba(255,255,255,0.1); border-radius: 100px; padding: 6px 16px; font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.55);">
                    <span id="heroNeighborhoods" class="text-white font-black">‚Äî</span> neighborhoods
                </div>
            </div>
        </div>
    </section>

    <!-- Sticky Search + Filters -->
    <header id="explore" class="sticky top-0 z-50 backdrop-blur-md">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex flex-col gap-3 w-full">
                <div class="relative w-full">
                    <input type="text" id="searchInput"
                           placeholder="Search startups by name, industry, keyword..."
                           class="w-full pl-11 pr-4 py-3 rounded-xl outline-none transition-all text-sm font-medium"
                           style="background: white; border: 1.5px solid var(--border); color: var(--text);"
                           onfocus="this.style.borderColor='var(--dark)'"
                           onblur="this.style.borderColor='var(--border)'">
                    <svg class="absolute left-3.5 top-3.5 h-5 w-5" style="color: #9ca3af;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
                <div id="filterContainer" class="flex gap-2 overflow-x-auto no-scrollbar w-full pb-1"></div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-6 py-8 w-full flex-grow">
        <div class="flex gap-8">

            <!-- Sidebar -->
            <aside class="map-sidebar w-64 flex-shrink-0">
                <div class="rounded-2xl p-5" style="background: white; border: 1.5px solid var(--border);">
                    <h3 class="text-xs font-black uppercase tracking-wider mb-4 flex items-center gap-2" style="color: var(--dark);">
                        <svg class="w-4 h-4" style="color: var(--accent);" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                        </svg>
                        Where We Build
                    </h3>
                    <div id="locationClusters" class="space-y-1.5"></div>
                </div>
            </aside>

            <!-- Grid -->
            <main class="flex-1 min-w-0">
                <div id="locationChipsMobile" class="flex gap-2 overflow-x-auto no-scrollbar pb-2 mb-3"></div>
                <div id="activeFilterBanner" class="hidden mb-4 px-4 py-2.5 rounded-xl flex items-center justify-between"
                     style="background: rgba(0, 229, 160, 0.08); border: 1px solid rgba(0, 229, 160, 0.2);">
                    <div class="flex items-center gap-2">
                        <svg class="w-3.5 h-3.5 flex-shrink-0" style="color: var(--accent);" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                        </svg>
                        <span id="activeFilterLabel" class="text-xs font-bold" style="color: var(--dark);"></span>
                    </div>
                    <button onclick="clearAllFilters()" class="text-xs font-bold px-2.5 py-1 rounded-lg transition-all hover:opacity-70"
                            style="color: var(--muted); background: rgba(10, 15, 30, 0.05);">Clear</button>
                </div>
                <div id="loadingState" class="flex flex-col items-center py-24">
                    <div class="w-8 h-8 border-4 rounded-full spinner"
                         style="border-color: var(--border); border-top-color: var(--dark);"></div>
                </div>
                <div id="directoryGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-4 hidden"></div>
                <div id="emptyState" class="hidden text-center py-24 rounded-3xl border-2 border-dashed" style="border-color: var(--border);">
                    <div class="text-4xl mb-3">üîç</div>
                    <p class="font-black text-lg" style="color: var(--dark);">No results found</p>
                    <p class="text-sm mt-1" style="color: var(--muted);">Try a different search or filter</p>
                </div>
            </main>
        </div>
    </div>

    <!-- Footer -->
    <footer style="background: var(--dark);" class="mt-20 relative overflow-hidden">
        <div class="hero-grid opacity-40"></div>
        <div class="max-w-7xl mx-auto px-6 py-16 relative z-10">
            <div class="flex flex-col md:flex-row justify-between items-start gap-12">
                <div>
                    <div class="text-2xl font-black tracking-tight mb-3">
                        <span class="text-white">CLT</span><span style="color: var(--accent);">Startups</span>
                    </div>
                    <p class="font-medium max-w-xs text-sm" style="color: rgba(255,255,255,0.35);">
                        A living index of startups building in Charlotte. Community-driven, always free.
                    </p>
                </div>
                <div>
                    <h2 class="text-xl font-black text-white mb-2">Missing a startup?</h2>
                    <p class="text-sm font-medium mb-5" style="color: rgba(255,255,255,0.4);">Help keep the index accurate and complete.</p>
                    <button onclick="openAddModal()"
                            style="background: var(--accent); color: var(--dark);"
                            class="px-6 py-3 rounded-full font-black text-sm hover:opacity-90 transition-all active:scale-95">
                        Add to Index
                    </button>
                </div>
            </div>
            <div class="mt-16 pt-8 border-t text-center text-xs font-bold uppercase tracking-widest"
                 style="border-color: rgba(255,255,255,0.07); color: rgba(255,255,255,0.2);">
                &copy; 2025 Charlotte Startup Index ¬∑ Built in the Queen City
            </div>
        </div>
    </footer>

    <!-- Modal -->
    <div id="uiModal" class="fixed inset-0 z-[100] hidden overflow-y-auto">
        <div class="fixed inset-0 modal-overlay" onclick="closeModal()"></div>
        <div class="relative min-h-screen flex items-center justify-center p-4 sm:p-8">
            <div id="modalBox" class="bg-white w-full max-w-2xl rounded-3xl p-8 md:p-10 shadow-2xl relative z-10">
                <button onclick="closeModal()"
                        class="absolute top-6 right-6 w-10 h-10 flex items-center justify-center rounded-full transition-all hover:opacity-70"
                        style="background: var(--bg); color: var(--muted);">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
                <div id="modalContent"></div>
            </div>
        </div>
    </div>

    <script>
        const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTNHcumKyuDJq7RH4oKSp-ANUo97oODMgmy3UBFKRISv-F5bnGawPcc_bTRyRm_Nqm0Oa44WzQl3Qcg/pub?gid=0&single=true&output=csv';
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxJMWzAyzORr1SqFlyKmerxhQ3LoeFnPNJmzZzk_k5yG3gResiW7V1QAZlxQ1zUyBhSCw/exec';

        // Category color palette ‚Äî deterministic from name
        const CAT_PALETTE = ['#6366f1','#10b981','#f59e0b','#ec4899','#0ea5e9','#f97316','#8b5cf6','#14b8a6','#ef4444','#a855f7','#84cc16'];
        function getCatColor(cat) {
            if (!cat) return CAT_PALETTE[0];
            let h = 0;
            for (let c of cat) h = ((h << 5) - h) + c.charCodeAt(0);
            return CAT_PALETTE[Math.abs(h) % CAT_PALETTE.length];
        }

        let resources = [];
        let uniqueCategories = [];
        let currentFilter = 'all';
        let currentLocationFilter = 'all';
        let searchQuery = '';
        let locationClusters = {};

        function categorizeLocation(location) {
            if (!location) return 'Unknown';
            const loc = location.toLowerCase();
            if (loc.includes('south end') || loc.includes('south blvd')) return 'South End';
            if (loc.includes('uptown')) return 'Uptown';
            if (loc.includes('plaza midwood')) return 'Plaza Midwood';
            if (loc.includes('dilworth') || loc.includes('montford') || loc.includes('park road') || loc.includes('myers park')) return 'Dilworth/Myers Park/Montford/Park Rd';
            if (loc.includes('south park') || loc.includes('southpark')) return 'SouthPark';
            if (loc.includes('ballantyne') || loc.includes('south charlotte') || loc.includes('matthews')) return 'South Charlotte';
            if (loc.includes('cotswold') || loc.includes('oakhurst')) return 'Cotswold/Oakhurst';
            if (loc.includes('north charlotte') || loc.includes('university') || loc.includes('concord') || loc.includes('huntersville')) return 'North Charlotte';
            if (loc.includes('airport') || loc.includes('renaissance') || loc.includes('billy graham')) return 'Airport Area';
            if (loc.includes('fort mill') || loc.includes('waxhaw') || loc.includes('rock hill') || loc.includes('mooresville') || loc.includes('lake norman')) return 'CLT Adjacent';
            return 'Other CLT/Remote Team';
        }

        function setLocationFilter(locationName) {
            if (locationName === 'all') {
                currentLocationFilter = 'all';
            } else {
                currentLocationFilter = (currentLocationFilter === locationName) ? 'all' : locationName;
            }
            displayLocationClusters();
            render();
            window.scrollTo({ top: document.getElementById('explore').offsetTop, behavior: 'smooth' });
        }

        function updateHqHubToggle() {
            const val = document.querySelector('input[name="hqhub"]:checked').value;
            const isHQ = val === 'HQ';
            document.getElementById('hqLabel').style.cssText = `background: ${isHQ ? 'var(--dark)' : 'var(--bg)'}; color: ${isHQ ? 'white' : 'var(--muted)'}; border: 1.5px solid ${isHQ ? 'var(--dark)' : 'var(--border)'};`;
            document.getElementById('hubLabel').style.cssText = `background: ${!isHQ ? 'var(--dark)' : 'var(--bg)'}; color: ${!isHQ ? 'white' : 'var(--muted)'}; border: 1.5px solid ${!isHQ ? 'var(--dark)' : 'var(--border)'};`;
        }

        function closeModal() {
            document.body.style.overflow = '';
            document.getElementById('uiModal').classList.add('hidden');
        }

        async function fetchData() {
            try {
                const response = await fetch(`${SHEET_CSV_URL}&t=${Date.now()}`);
                const csvData = await response.text();
                resources = parseCSV(csvData);

                const cats = new Set();
                resources.forEach(r => { if (r.category) cats.add(r.category); });
                uniqueCategories = Array.from(cats).sort();

                document.getElementById('heroCount').textContent = resources.length;
                document.getElementById('heroCats').textContent = uniqueCategories.length;

                buildLocationClusters();
                setupFilters();
                render();
            } catch (e) {
                document.getElementById('loadingState').innerHTML = `<p class="font-bold" style="color: #ef4444;">Error loading data.</p>`;
            }
        }

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            if (lines.length < 2) return [];
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            return lines.slice(1).map(line => {
                const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                const obj = {};
                headers.forEach((h, i) => obj[h] = (values[i] || '').replace(/"/g, '').trim());
                return obj;
            }).filter(item => item.title && item.status && item.status.toUpperCase() === 'APPROVED');
        }

        function buildLocationClusters() {
            locationClusters = {};
            resources.forEach(r => {
                if (r.location) {
                    const cluster = categorizeLocation(r.location);
                    if (!locationClusters[cluster]) locationClusters[cluster] = { hq: 0, hub: 0, companies: [] };
                    if (r.location.toLowerCase().includes('hq')) locationClusters[cluster].hq++;
                    else locationClusters[cluster].hub++;
                    locationClusters[cluster].companies.push(r.title);
                }
            });
            displayLocationClusters();
            document.getElementById('heroNeighborhoods').textContent = Object.keys(locationClusters).length;
        }

        function displayLocationClusters() {
            const container = document.getElementById('locationClusters');
            const sorted = Object.entries(locationClusters).sort((a, b) => (b[1].hq + b[1].hub) - (a[1].hq + a[1].hub));
            const totalCompanies = sorted.reduce((sum, [, d]) => sum + d.hq + d.hub, 0);
            const isAllActive = currentLocationFilter === 'all';

            const allBtn = `
                <div onclick="setLocationFilter('all')" class="location-reset px-3 py-2 ${isAllActive ? 'active' : ''}">
                    <div class="flex items-center justify-between">
                        <span class="text-xs font-bold" style="color: ${isAllActive ? 'var(--dark)' : 'var(--muted)'};">All Locations</span>
                        <span class="text-xs font-black px-2 py-0.5 rounded-full" style="background: ${isAllActive ? 'rgba(0,229,160,0.12)' : 'var(--bg)'}; color: var(--dark);">${totalCompanies}</span>
                    </div>
                </div>`;

            const clusters = sorted.map(([name, data]) => {
                const total = data.hq + data.hub;
                const isActive = currentLocationFilter === name;
                return `
                    <div onclick="setLocationFilter('${name}')" class="location-cluster px-3 py-2.5 ${isActive ? 'active' : ''}">
                        <div class="flex items-center justify-between mb-0.5">
                            <span class="cluster-name text-sm font-bold truncate pr-2" style="color: var(--dark);">${name}</span>
                            <span class="cluster-count text-xs font-black px-2 py-0.5 rounded-full flex-shrink-0" style="background: var(--bg); color: var(--dark);">${total}</span>
                        </div>
                        <div class="cluster-sub flex items-center gap-3 text-xs font-medium" style="color: var(--muted);">
                            ${data.hq > 0 ? `<div class="flex items-center gap-1"><div class="pin-hq location-pin"></div><span>${data.hq} HQ</span></div>` : ''}
                            ${data.hub > 0 ? `<div class="flex items-center gap-1"><div class="pin-hub location-pin"></div><span>${data.hub}</span></div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = allBtn + clusters;

            const mobileContainer = document.getElementById('locationChipsMobile');
            if (mobileContainer) {
                const mobileAllChip = `<button onclick="setLocationFilter('all')" class="category-pill loc-chip px-4 py-1.5 rounded-full border transition-all uppercase ${isAllActive ? 'active' : ''}" style="border-color: ${isAllActive ? 'var(--dark)' : 'var(--border)'}; background: ${isAllActive ? 'var(--dark)' : 'white'}; color: ${isAllActive ? 'white' : 'var(--dark)'}; flex-shrink: 0;">All</button>`;
                const mobileChips = sorted.map(([name, data]) => {
                    const total = data.hq + data.hub;
                    const isActive = currentLocationFilter === name;
                    return `<button onclick="setLocationFilter('${name}')" class="category-pill loc-chip px-4 py-1.5 rounded-full border transition-all uppercase ${isActive ? 'active' : ''}" style="border-color: ${isActive ? 'var(--dark)' : 'var(--border)'}; background: ${isActive ? 'var(--dark)' : 'white'}; color: ${isActive ? 'white' : 'var(--dark)'}; flex-shrink: 0;">${name} (${total})</button>`;
                }).join('');
                mobileContainer.innerHTML = mobileAllChip + mobileChips;
            }
        }

        function setupFilters() {
            const counts = {};
            resources.forEach(r => { if (r.category) counts[r.category] = (counts[r.category] || 0) + 1; });
            let cats = Object.keys(counts).sort((a, b) => counts[b] - counts[a]);
            const otherIndex = cats.findIndex(c => c.toLowerCase() === 'other');
            if (otherIndex > -1) { const other = cats.splice(otherIndex, 1)[0]; cats.push(other); }
            cats = ['all', ...cats];

            const container = document.getElementById('filterContainer');
            container.innerHTML = cats.map(c => `
                <button onclick="setFilter('${c}')"
                        class="category-pill px-4 py-1.5 rounded-full border transition-all uppercase ${c === 'all' ? 'active' : ''}"
                        style="border-color: var(--border); background: white; color: ${c === 'all' ? 'white' : 'var(--dark)'};">
                    ${c === 'all' ? 'All' : c}
                </button>
            `).join('');
        }

        function clearAllFilters() {
            currentLocationFilter = 'all';
            currentFilter = 'all';
            displayLocationClusters();
            document.querySelectorAll('.category-pill:not(.loc-chip)').forEach(el => {
                const isAll = el.innerText.trim().toLowerCase() === 'all';
                el.classList.toggle('active', isAll);
                el.style.background = isAll ? 'var(--dark)' : 'white';
                el.style.color = isAll ? 'white' : 'var(--dark)';
                el.style.borderColor = isAll ? 'var(--dark)' : 'var(--border)';
            });
            render();
            window.scrollTo({ top: document.getElementById('explore').offsetTop, behavior: 'smooth' });
        }

        function setFilter(cat) {
            currentFilter = cat;
            document.querySelectorAll('.category-pill:not(.loc-chip)').forEach(el => {
                const label = el.innerText.trim().toLowerCase();
                const isActive = label === cat.toLowerCase() || (cat === 'all' && label === 'all');
                el.classList.toggle('active', isActive);
                el.style.background = isActive ? 'var(--dark)' : 'white';
                el.style.color = isActive ? 'white' : 'var(--dark)';
                el.style.borderColor = isActive ? 'var(--dark)' : 'var(--border)';
            });
            render();
            window.scrollTo({ top: document.getElementById('explore').offsetTop, behavior: 'smooth' });
        }

        function render() {
            document.getElementById('loadingState').classList.add('hidden');
            const grid = document.getElementById('directoryGrid');
            const emptyState = document.getElementById('emptyState');

            const banner = document.getElementById('activeFilterBanner');
            const hasLocationFilter = currentLocationFilter !== 'all';
            const hasCategoryFilter = currentFilter !== 'all';
            if (hasLocationFilter || hasCategoryFilter) {
                banner.classList.remove('hidden');
                const parts = [];
                if (hasCategoryFilter) parts.push(currentFilter);
                if (hasLocationFilter) parts.push(currentLocationFilter);
                document.getElementById('activeFilterLabel').textContent = 'Filtering: ' + parts.join(' ¬∑ ');
            } else {
                banner.classList.add('hidden');
            }

            const filtered = resources.filter(r => {
                const matchesFilter = (currentFilter === 'all' || r.category === currentFilter);
                const matchesLocation = (currentLocationFilter === 'all' || categorizeLocation(r.location) === currentLocationFilter);
                const matchesSearch = r.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
                                      r.description.toLowerCase().includes(searchQuery.toLowerCase());
                return matchesFilter && matchesLocation && matchesSearch;
            });

            if (filtered.length === 0) {
                grid.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            grid.classList.remove('hidden');

            grid.innerHTML = filtered.map(r => {
                const domainStr = r.link ? r.link.replace(/^https?:\/\//, '').split('/')[0] : '';
                const finalLogoUrl = (r.logo && r.logo.trim()) ? r.logo : `https://logo.clearbit.com/${domainStr}`;
                const catColor = getCatColor(r.category);

                const locationBadge = r.location ? `
                    <div class="flex items-center gap-1 text-xs mt-2 font-medium" style="color: var(--muted);">
                        <svg class="w-3 h-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                        </svg>
                        <span class="truncate">${r.location}</span>
                    </div>
                ` : '';

                return `
                <div class="startup-card p-5 flex flex-col h-full" style="--card-accent: ${catColor};" data-logo="${finalLogoUrl}" data-fallback="${catColor}">
                    <div class="flex gap-4 items-start mb-4">
                        <img src="${finalLogoUrl}"
                             class="w-14 h-14 rounded-xl object-contain flex-shrink-0 p-1.5"
                             style="background: var(--bg); border: 1.5px solid var(--border);"
                             onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(r.title)}&background=random&size=56'">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-start justify-between gap-2 mb-1">
                                <a href="${r.link}" target="_blank"
                                   class="font-black text-base leading-tight hover:opacity-60 transition-opacity"
                                   style="color: var(--dark);">${r.title}</a>
                                <span class="text-[10px] font-black uppercase tracking-wide px-2 py-0.5 rounded-md flex-shrink-0"
                                      style="color: var(--muted); background: var(--bg); border: 1px solid var(--border);">${r.category}</span>
                            </div>
                            ${r.lastfunding ? `
                            <span class="text-[10px] font-black uppercase tracking-wide px-2 py-0.5 rounded-md"
                                  style="color: var(--muted); background: var(--bg); border: 1px solid var(--border);">
                                ${r.lastfunding}
                            </span>` : ''}
                            <p class="text-sm leading-relaxed" style="color: var(--muted);">${r.description}</p>
                            ${locationBadge}
                        </div>
                    </div>
                    <div class="mt-auto pt-3 border-t flex gap-2" style="border-color: var(--border);">
                        ${r.linkedin ? `
                        <a href="${r.linkedin}" target="_blank"
                           class="px-3 py-2 rounded-xl text-xs font-bold transition-all hover:opacity-80"
                           style="background: #0A66C2; color: white;">
                            LinkedIn ‚Üí
                        </a>` : ''}
                        ${r.link ? `
                        <a href="${r.link}" target="_blank"
                           class="px-4 py-2 rounded-xl text-xs font-bold transition-all hover:opacity-80"
                           style="background: var(--dark); color: white;">
                            Website ‚Üí
                        </a>` : ''}
                    </div>
                </div>
                `;
            }).join('');

            applyLogoColors();
        }

        function getDominantColor(img) {
            try {
                const size = 48;
                const canvas = document.createElement('canvas');
                canvas.width = size;
                canvas.height = size;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, size, size);
                const data = ctx.getImageData(0, 0, size, size).data;

                // 12 hue buckets of 30¬∞ each; weight by saturation √ó mid-lightness
                const buckets = new Array(12).fill(0);
                const samples = Array.from({length: 12}, () => ({r: 0, g: 0, b: 0, w: 0}));

                for (let i = 0; i < data.length; i += 4) {
                    if (data[i+3] < 128) continue;
                    const r = data[i] / 255, g = data[i+1] / 255, b = data[i+2] / 255;
                    const max = Math.max(r, g, b), min = Math.min(r, g, b), d = max - min;
                    const l = (max + min) / 2;
                    const s = d === 0 ? 0 : d / (1 - Math.abs(2 * l - 1));
                    if (s < 0.2 || l > 0.88 || l < 0.04) continue; // skip gray/white/black
                    let h = 0;
                    if (d > 0) {
                        if (max === r)      h = (((g - b) / d) % 6 + 6) % 6 / 6;
                        else if (max === g) h = ((b - r) / d + 2) / 6;
                        else               h = ((r - g) / d + 4) / 6;
                    }
                    const bucket = Math.floor(h * 12) % 12;
                    const w = s; // weight by saturation only ‚Äî dark brand colors count equally
                    buckets[bucket] += w;
                    samples[bucket].r += data[i]   * w;
                    samples[bucket].g += data[i+1] * w;
                    samples[bucket].b += data[i+2] * w;
                    samples[bucket].w += w;
                }

                const top = buckets.indexOf(Math.max(...buckets));
                if (buckets[top] === 0) return null;
                const s = samples[top];
                return `rgb(${Math.round(s.r/s.w)},${Math.round(s.g/s.w)},${Math.round(s.b/s.w)})`;
            } catch(e) {
                return null;
            }
        }

        function applyLogoColors() {
            document.querySelectorAll('.startup-card[data-logo]').forEach(card => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = function() {
                    const color = getDominantColor(img);
                    card.style.setProperty('--card-accent', color || '#0a0f1e');
                };
                img.src = card.dataset.logo;
            });
        }

        function openAddModal() {
            const modal = document.getElementById('uiModal');
            const content = document.getElementById('modalContent');
            document.body.style.overflow = 'hidden';
            modal.classList.remove('hidden');

            const catOptions = uniqueCategories.map(c => `<option value="${c}">${c}</option>`).join('');

            const submitSubtitles = [
                "Startups move fast. Help the index keep up.",
                "Every great company starts somewhere. Make sure we know about it.",
                "The 704 is building. Don't let anyone miss it."
            ];
            const subtitle = submitSubtitles[Math.floor(Math.random() * submitSubtitles.length)];

            content.innerHTML = `
                <div class="space-y-5">
                    <div>
                        <h2 class="text-2xl font-black tracking-tight" style="color: var(--dark);">Submit a Startup</h2>
                        <p class="font-medium mt-1 text-sm" style="color: var(--muted);">${subtitle}</p>
                    </div>
                    <form id="addForm" class="space-y-3">
                        <div class="space-y-1">
                            <label class="text-[10px] font-black uppercase tracking-widest" style="color: var(--muted);">Company Name</label>
                            <input type="text" name="title" required placeholder="Insert Startup Here"
                                   class="w-full px-3 py-2.5 rounded-xl outline-none transition-all text-sm font-medium"
                                   style="background: var(--bg); border: 1.5px solid var(--border); color: var(--dark);"
                                   onfocus="this.style.borderColor='var(--dark)'" onblur="this.style.borderColor='var(--border)'">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div class="space-y-1">
                                <label class="text-[10px] font-black uppercase tracking-widest" style="color: var(--muted);">Industry</label>
                                <select name="category" required
                                        class="w-full px-3 py-2.5 rounded-xl outline-none transition-all text-sm appearance-none font-medium"
                                        style="background: var(--bg); border: 1.5px solid var(--border); color: var(--dark);">
                                    <option value="" disabled selected>Select Industry</option>
                                    ${catOptions}
                                </select>
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] font-black uppercase tracking-widest" style="color: var(--muted);">Website</label>
                                <input type="text" name="link" placeholder="websitegoeshere.com" required
                                       class="w-full px-3 py-2.5 rounded-xl outline-none transition-all text-sm font-medium"
                                       style="background: var(--bg); border: 1.5px solid var(--border); color: var(--dark);"
                                       onfocus="this.style.borderColor='var(--dark)'" onblur="this.style.borderColor='var(--border)'">
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-black uppercase tracking-widest" style="color: var(--muted);">What They're Building</label>
                            <input type="text" name="description" required placeholder="The elevator pitch. 10 seconds. Go."
                                   class="w-full px-3 py-2.5 rounded-xl outline-none transition-all text-sm font-medium"
                                   style="background: var(--bg); border: 1.5px solid var(--border); color: var(--dark);"
                                   onfocus="this.style.borderColor='var(--dark)'" onblur="this.style.borderColor='var(--border)'">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div class="space-y-1">
                                <label class="text-[10px] font-black uppercase tracking-widest" style="color: var(--muted);">Charlotte Presence</label>
                                <div class="flex gap-2">
                                    <label id="hqLabel" class="flex-1 text-center py-2.5 rounded-xl text-sm font-bold cursor-pointer transition-all" style="background: var(--dark); color: white; border: 1.5px solid var(--dark);">
                                        <input type="radio" name="hqhub" value="HQ" class="hidden" checked onchange="updateHqHubToggle()"> HQ
                                    </label>
                                    <label id="hubLabel" class="flex-1 text-center py-2.5 rounded-xl text-sm font-bold cursor-pointer transition-all" style="background: var(--bg); color: var(--muted); border: 1.5px solid var(--border);">
                                        <input type="radio" name="hqhub" value="Hub" class="hidden" onchange="updateHqHubToggle()"> Hub
                                    </label>
                                </div>
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] font-black uppercase tracking-widest" style="color: var(--muted);">LinkedIn <span class="font-medium normal-case tracking-normal" style="color: var(--muted);">(optional)</span></label>
                                <input type="text" name="linkedin" placeholder="linkedin.com/company/yourco"
                                       class="w-full px-3 py-2.5 rounded-xl outline-none transition-all text-sm font-medium"
                                       style="background: var(--bg); border: 1.5px solid var(--border); color: var(--dark);"
                                       onfocus="this.style.borderColor='var(--dark)'" onblur="this.style.borderColor='var(--border)'">
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-black uppercase tracking-widest" style="color: var(--muted);">Neighborhood <span class="font-medium normal-case tracking-normal" style="color: var(--muted);">(optional)</span></label>
                            <input type="text" name="neighborhood" placeholder="e.g. South End, Uptown"
                                   class="w-full px-3 py-2.5 rounded-xl outline-none transition-all text-sm font-medium"
                                   style="background: var(--bg); border: 1.5px solid var(--border); color: var(--dark);"
                                   onfocus="this.style.borderColor='var(--dark)'" onblur="this.style.borderColor='var(--border)'">
                        </div>
                        <div id="formErrorMessage" class="hidden p-3 rounded-xl text-sm font-bold" style="background: #fef2f2; color: #ef4444;"></div>
                        <button type="submit" id="submitBtn"
                                class="w-full py-3 rounded-2xl font-black text-sm transition-all hover:opacity-90 active:scale-[0.98]"
                                style="background: var(--dark); color: white;">
                            Submit Entry
                        </button>
                    </form>
                </div>
            `;

            document.getElementById('addForm').onsubmit = async (e) => {
                e.preventDefault();
                const btn = document.getElementById('submitBtn');
                const errorMsg = document.getElementById('formErrorMessage');
                btn.disabled = true;
                btn.innerText = 'Sending...';
                errorMsg.classList.add('hidden');

                const formData = new FormData(e.target);
                const hqHub = formData.get('hqhub');
                const neighborhood = (formData.get('neighborhood') || '').trim();
                const data = {
                    title: formData.get('title'),
                    category: formData.get('category'),
                    description: formData.get('description'),
                    link: formData.get('link'),
                    location: hqHub + ' in ' + (neighborhood || 'CLT'),
                    linkedin: formData.get('linkedin'),
                    timestamp: new Date().toLocaleString()
                };

                const submitWithRetry = async (retries = 5, delay = 1000) => {
                    try {
                        await fetch(APPS_SCRIPT_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                        content.innerHTML = `
                            <div class="text-center py-12">
                                <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-5" style="background: #f0fdf4;">
                                    <svg class="w-8 h-8" style="color: #10b981;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/>
                                    </svg>
                                </div>
                                <h2 class="text-3xl font-black" style="color: var(--dark);">Submitted!</h2>
                                <p class="mt-2 font-medium" style="color: var(--muted);">Your entry has been sent for review.</p>
                                <button onclick="closeModal()"
                                        class="mt-8 px-8 py-3 rounded-full font-bold text-sm hover:opacity-70 transition-all"
                                        style="background: var(--bg); color: var(--dark);">Close</button>
                            </div>`;
                    } catch (err) {
                        if (retries > 0) {
                            setTimeout(() => submitWithRetry(retries - 1, delay * 2), delay);
                        } else {
                            btn.disabled = false;
                            btn.innerText = 'Submit Entry';
                            errorMsg.innerText = "Submission failed. Please check your connection.";
                            errorMsg.classList.remove('hidden');
                        }
                    }
                };

                await submitWithRetry();
            };
        }

        document.getElementById('searchInput').oninput = (e) => { searchQuery = e.target.value; render(); };
        window.onload = fetchData;
    </script>
</body>
</html>
